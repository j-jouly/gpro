<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Presensi Digital - Professional</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #059669;
            --danger: #dc2626;
            --surface: #ffffff;
            --background: #f8fafc;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --radius-lg: 20px;
            --radius-md: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .app-container { width: 100%; max-width: 480px; padding: 20px; }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            padding: 10px 5px;
        }

        .user-info { display: flex; align-items: center; gap: 12px; }

        .avatar {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 700; font-size: 1.1rem;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
        }

        .user-text h2 { margin: 0; font-size: 16px; font-weight: 700; }
        .user-text p { margin: 0; font-size: 13px; color: var(--text-muted); }

        .card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .card-label {
            display: block; font-size: 12px; font-weight: 700;
            color: var(--primary); text-transform: uppercase;
            margin-bottom: 12px; letter-spacing: 0.05em;
        }

        select {
            width: 100%; padding: 14px 16px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            background-color: #f1f5f9;
            font-size: 15px; color: var(--text-main);
            appearance: none; cursor: pointer;
        }

        .camera-viewport {
            width: 100%; aspect-ratio: 4/5;
            background: #000; border-radius: var(--radius-md);
            overflow: hidden; position: relative; margin-bottom: 15px;
        }

        video, canvas { width: 100%; height: 100%; object-fit: cover; }        
        #photo-preview {
            display: none;
            width: 100%;
            height: auto; 
            max-height: 400px; /* Batasi tinggi preview agar tidak meluber ke bawah layar */
            object-fit: contain; /* Menampilkan seluruh gambar tanpa terpotong */
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            margin-bottom: 15px;
        }

        .btn {
            width: 100%; padding: 16px; border-radius: var(--radius-md);
            font-size: 15px; font-weight: 600; border: none;
            cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        .btn-primary { 
            background: var(--primary); color: white; 
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Transisi halus */
            position: relative;
            overflow: hidden;
        }

        /* Efek Hover (Saat kursor di atas tombol atau disentuh) */
        @media (hover: hover) {
            .btn-primary:hover {
                background: var(--primary-dark);
                transform: translateY(-2px); /* Tombol sedikit terangkat */
                box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
            }
        }
        
        /* Efek Active (Saat tombol sedang ditekan/klik) */
        .btn-primary:active {
            transform: translateY(2px); /* Tombol terasa tertekan ke bawah */
            box-shadow: 0 2px 4px -1px rgba(37, 99, 235, 0.2);
            background: #1e40af; /* Biru yang lebih gelap lagi */
            transition: all 0.1s;
        }
        
        /* Tambahan: Efek Loading/Disabled agar tidak flat saat proses */
        .btn-primary:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-orange {
            background: #e64a19; color: white; margin-top: 10px;
            box-shadow: 0 4px 12px rgba(230, 74, 25, 0.25);
        }

        .btn-orange:hover { background: #bf360c; transform: translateY(-2px); }
        /* Efek membal saat diklik */
        .btn-orange:active {transform: scale(0.95);}
        
        .action-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn-in { background: var(--success); color: white; }
        .btn-out { background: var(--danger); color: white; }

        .status-pill {
            padding: 12px; border-radius: var(--radius-md);
            font-size: 13px; font-weight: 500; display: none;
            margin-bottom: 15px; line-height: 1.5;
        }
        .status-pill.success { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; }
        .status-pill.error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <div class="user-info">
            <div class="avatar" id="user-initial">A</div>
            <div class="user-text">
                <h2 id="user-name">Memuat...</h2>
                <p id="user-id">ID: -</p>
            </div>
        </div>
        <div class="date-badge" style="text-align: right;">
            <div id="live-clock" style="font-weight: 700; color: var(--primary);">00:00</div>
            <div style="font-size: 11px; color: var(--text-muted);" id="live-date">24 Feb 2026</div>
        </div>
    </div>

    <div class="card">
        <span class="card-label">üìç Konfigurasi Lokasi</span>
        
        <div style="margin-top: 15px;" id="status-display" class="status-pill"></div>
        
        <div class="select-wrapper">
            <select id="location-select">
                <option value="" disabled selected>Pilih Area Tugas</option>
                <option value="outlet">üç± Area Outlet</option>
                <option value="ck">üè≠ Area CK</option>
                <option value="admin">üè¢ Area Admin</option>
            </select>
        </div>
        
        <div style="margin-top: 15px;">
            <button class="btn btn-primary" id="btn-lock-location">üìç Konfirmasi Lokasi & Cek GPS</button>
        </div>
        
    </div>

    <div id="camera-section" class="card" style="display: none;">
        <span class="card-label">üßî Verifikasi Wajah</span>
        <div class="camera-viewport" id="viewport">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display:none;"></canvas>
            <img id="photo-preview" alt="Preview">
        </div>
        <div class="action-group" id="main-actions">
            <button class="btn btn-in" id="btn-checkin">‚è¨ Masuk</button>
            <button class="btn btn-out" id="btn-checkout">‚è´ Pulang</button>
        </div>
        <button class="btn" id="btn-retry" style="display:none; margin-top:10px;" onclick="resetCamera()">üì∏ Foto Ulang</button>
    </div>

    <button class="btn btn-orange" onclick="window.location.href='dashboard.html'">üè† Kembali ke Beranda</button>
</div>

<script>
    const SUPABASE_URL = 'https://bzrycuvpbsxvutqhxowp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6cnljdXZwYnN4dnV0cWh4b3dwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNTk5OTEsImV4cCI6MjA4NjkzNTk5MX0.MI2suZLflcMbc5AbPCRaT7_pT9qQISrsV5dKA63Si8s';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const LOCATIONS = {
        outlet: { lat: -7.4665628, lng: 112.4461021, radius: 70 },
        ck: { lat: -7.487560, lng: 112.429730, radius: 70 },
        admin: { lat: -7.366710, lng: 112.610286, radius: 100 }
    };

    let userCoords = { lat: 0, lng: 0 };
    let selectedLoc = null;
    let currentDist = 0;

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const p1 = lat1 * Math.PI/180;
        const p2 = lat2 * Math.PI/180;
        const dp = (lat2-lat1) * Math.PI/180;
        const dl = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dp/2) * Math.sin(dp/2) + Math.cos(p1) * Math.cos(p2) * Math.sin(dl/2) * Math.sin(dl/2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    document.getElementById('btn-lock-location').addEventListener('click', function() {
        const locKey = document.getElementById('location-select').value;
        const statusPill = document.getElementById('status-display');

        if (!locKey) return alert('Pilih lokasi terlebih dahulu!');

        const btn = this;
        btn.innerHTML = "‚è≥ Menghubungkan GPS...";
        btn.disabled = true; // Mencegah klik ganda
        
        selectedLoc = LOCATIONS[locKey];
        statusPill.style.display = 'block';
        statusPill.className = 'status-pill info';
        statusPill.textContent = 'üì° Mengecek koordinat GPS...';

        navigator.geolocation.getCurrentPosition((pos) => {
            userCoords.lat = pos.coords.latitude;
            userCoords.lng = pos.coords.longitude;
            currentDist = getDistance(userCoords.lat, userCoords.lng, selectedLoc.lat, selectedLoc.lng);

            if (currentDist <= selectedLoc.radius) {
                statusPill.className = 'status-pill success';
                statusPill.innerHTML = `‚úÖ <b>Berhasil!</b> Jarak: ${currentDist.toFixed(1)}m.`;
                document.getElementById('camera-section').style.display = 'block';
                startCamera();
            } else {
                statusPill.className = 'status-pill error';
                statusPill.innerHTML = `‚ùå <b>Diluar Radius!</b> Jarak: ${currentDist.toFixed(1)}m. (Maks ${selectedLoc.radius}m)`;
            }
        }, (err) => {
            statusPill.className = 'status-pill error';
            statusPill.textContent = "Error GPS: " + err.message;
        }, { enableHighAccuracy: true });
    });

    async function startCamera() {
        const video = document.getElementById('video');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            video.srcObject = stream;
        } catch (e) { alert('Izin kamera ditolak!'); }
    }

    function resetCamera() {
        document.getElementById('photo-preview').style.display = 'none';
        document.getElementById('video').style.display = 'block';
        document.getElementById('btn-retry').style.display = 'none';
        document.getElementById('main-actions').style.display = 'grid';
    }

async function submitAbsence(type) {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const session = JSON.parse(localStorage.getItem('userSession') || '{}');
    const loctArea = document.getElementById('location-select').value;
    
    if (!session.username) return alert("Sesi habis!");

    // 1. Persiapan Canvas
    const ctx = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    // 2. Gambar Foto dari Video ke Canvas
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // 3. TAMBAHKAN WATERMARK (Overlay Hitam Transparan)
    const boxHeight = 130; // 120
    const bottomPadding = 40; // 45 - 25 // Jarak aman dari pinggir paling bawah agar tidak terpotong
    ctx.fillStyle = "rgba(0, 0, 0, 0.65)"; //0.7 - 0.6 // Background hitam transparan
    ctx.fillRect(0, canvas.height - boxHeight, canvas.width, boxHeight);

    // 4. TEKS WATERMARK
    const now = new Date();
    const timeStr = now.toLocaleTimeString('id-ID').replace(/\./g, ':');
    const dateStr = now.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });

    const statusSymbol = (type.toLowerCase().includes('in')) ? "üü¢" : "üî¥";
    ctx.fillStyle = "white";
    ctx.textBaseline = "bottom"; // Memudahkan pengaturan jarak teks
    ctx.font = "bold 20px Inter, Arial";    
    //ctx.fillText(type.toUpperCase() + " - " + session.username.toUpperCase(), 20, canvas.height - 70);
    ctx.fillText(`${statusSymbol} ${type.toUpperCase()} - ${session.korxname.toUpperCase()}`, 20, canvas.height - (bottomPadding + 55));
    
    ctx.font = "18px Inter, Arial";
    ctx.fillStyle = "#e2e8f0";
    ctx.fillText(`üìç Area: ${loctArea} | Jarak: ${currentDist.toFixed(1)}m`, 20, canvas.height - 40);
    ctx.fillText(`üïí ${dateStr} ${timeStr} | ${userCoords.lat.toFixed(6)}, ${userCoords.lng.toFixed(6)}`, 20, canvas.height - 15);

    // 5. Tampilkan Preview di UI
    const photoDataUrl = canvas.toDataURL('image/jpeg', 0.8);
    document.getElementById('photo-preview').src = photoDataUrl;
    document.getElementById('photo-preview').style.display = 'block';
    document.getElementById('video').style.display = 'none';
    document.getElementById('btn-retry').style.display = 'block';
    document.getElementById('main-actions').style.display = 'none';

    // 6. PROSES UPLOAD (Foto yang sudah ada watermark-nya)
    try {
        const blob = await (await fetch(photoDataUrl)).blob();
        
        // Format Nama File: IN_Nama_Area_Tanggal_Jam.jpg
        const fileTimestamp = now.getFullYear() + "" + (now.getMonth()+1) + "" + now.getDate() + "_" + now.getHours() + "" + now.getMinutes();
        const fileName = `${type.replace(/\s/g, '')}_${session.korxname}_${loctArea}_${fileTimestamp}.jpg`;
        const filePath = `captures/${fileName}`;

        // Upload ke Storage
        const { data: uploadData, error: upErr } = await supabaseClient.storage
            .from('attendance-photos')
            .upload(filePath, blob);

        if (upErr) throw upErr;

        // Ambil URL Publik
        const { data: urlData } = supabaseClient.storage
            .from('attendance-photos')
            .getPublicUrl(filePath);

        // Simpan ke Database
        const payload = {
            EMPL_NMBR: session.emplnmbr || session.id || "admin",
            KORX_NAME: session.korxname,
            TRAN_DATE: now.toISOString().split('T')[0],
            TRAN_TIME: timeStr,
            TRAN_STAT: type,
            LANG_GPSX: userCoords.lng,
            LATT_GPSX: userCoords.lat,
            RADS_GPSX: Math.round(currentDist),
            DEVC_NAME: navigator.userAgent,
            LOCT_AREA: loctArea,
            IMGE_URLX: urlData.publicUrl
        };

        const { error: dbErr } = await supabaseClient.from('TH_ATTN01').insert([payload]);
        if (dbErr) throw dbErr;

        alert(`Berhasil ${type}! Foto dengan watermark telah tersimpan.`);
        window.location.href = 'dashboard.html';

    } catch (err) {
        alert("Gagal menyimpan: " + err.message);
        console.error(err);
        resetCamera();
    }
}

    function updateClock() {
        const now = new Date();
        document.getElementById('live-clock').innerText = now.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
        document.getElementById('live-date').innerText = now.toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'});
    }
    setInterval(updateClock, 1000);
    updateClock();

    const sess = JSON.parse(localStorage.getItem('userSession') || '{}');
    if(sess.username) {
        document.getElementById('user-name').innerText = sess.username;
        document.getElementById('user-id').innerText = "ID: " + (sess.emplnmbr || sess.id || 'N/A');
        document.getElementById('user-initial').innerText = sess.username.charAt(0).toUpperCase();
    }

    document.getElementById('btn-checkin').addEventListener('click', () => submitAbsence('Check In'));
    document.getElementById('btn-checkout').addEventListener('click', () => submitAbsence('Check Out'));
</script>

</body>
</html>
