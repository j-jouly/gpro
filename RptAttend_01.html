<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Attendance - TH_ATTN01</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
            --white: #ffffff;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #edf2f7;
            padding: 20px;
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            background: var(--white);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        /* Filter Area */
        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            background: var(--light-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            align-items: end;
        }

        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-size: 0.75rem; font-weight: bold; margin-bottom: 5px; color: var(--primary-color); }
        .form-group input { padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; }

        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; color: white; }
        .btn-search { background: var(--accent-color); }
        .btn-loading { background: #95a5a6; cursor: not-allowed; }

        /* Table */
        .table-container { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        thead { background: var(--primary-color); color: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        tr:hover { background: #f1f7ff; }

        /* Image Hover Preview */
        .img-wrapper { position: relative; display: inline-block; }
        .thumb { width: 45px; height: 45px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .preview-box {
            display: none; position: absolute; bottom: 55px; left: 50%;
            transform: translateX(-50%); z-index: 99; background: white;
            padding: 5px; border-radius: 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .preview-box img { width: 200px; border-radius: 5px; }
        .img-wrapper:hover .preview-box { display: block; }

        .status-in { color: var(--success-color); font-weight: bold; }
        .status-out { color: var(--warning-color); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <header><h2>Attendance Report (TH_ATTN01)</h2></header>

    <div class="filter-section">
        <div class="form-group"><label>Start Date</label><input type="date" id="startDate"></div>
        <div class="form-group"><label>End Date</label><input type="date" id="endDate"></div>
        <div class="form-group"><label>Employee ID</label><input type="text" id="emplId" placeholder="EMPL_NMBR"></div>
        <button class="btn btn-search" id="btnSearch" onclick="fetchAttendanceData()">Search Data</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>EMPL_NMBR</th>
                    <th>NAME</th>
                    <th>DATE</th>
                    <th>IN</th>
                    <th>OUT</th>
                    <th>AREA IN</th>
                    <th>AREA OUT</th>
                    <th>IMG IN</th>
                    <th>IMG OUT</th>
                </tr>
            </thead>
            <tbody id="attendanceBody">
                <tr><td colspan="9" style="text-align:center;">Klik Search untuk memuat data...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // Konfigurasi Supabase
    const SUPABASE_URL = 'https://bzrycuvpbsxvutqhxowp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // Gunakan Key Lengkap Anda
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function fetchAttendanceData() {
        const btn = document.getElementById('btnSearch');
        const tbody = document.getElementById('attendanceBody');
        
        btn.innerText = "Loading...";
        btn.classList.add('btn-loading');
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">Mengambil data dari Supabase...</td></tr>';

        try {
            // Ambil data mentah dari tabel TH_ATTN01
            let query = _supabase.from('TH_ATTN01').select('*');

            // Apply Filters (Jika diisi)
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const id = document.getElementById('emplId').value;

            if (start) query = query.gte('TRAN_DATE', start);
            if (end) query = query.lte('TRAN_DATE', end);
            if (id) query = query.eq('EMPL_NMBR', id);

            const { data, error } = await query;

            if (error) throw error;

            // --- PROSES PIVOT (Menggabungkan IN & OUT menjadi 1 baris) ---
            const groupedData = {};

            data.forEach(row => {
                const key = `${row.EMPL_NMBR}_${row.TRAN_DATE}`;
                if (!groupedData[key]) {
                    groupedData[key] = {
                        EMPL_NMBR: row.EMPL_NMBR,
                        KORX_NAME: row.KORX_NAME,
                        TRAN_DATE: row.TRAN_DATE,
                        IN_TIME: '-', OUT_TIME: '-',
                        AREA_IN: '-', AREA_OUT: '-',
                        IMG_IN: '', IMG_OUT: ''
                    };
                }

                if (row.TRAN_STAT === 'IN') {
                    groupedData[key].IN_TIME = row.TRAN_TIME;
                    groupedData[key].AREA_IN = row.LOCT_AREA;
                    groupedData[key].IMG_IN = row.IMGE_URLX;
                } else {
                    groupedData[key].OUT_TIME = row.TRAN_TIME;
                    groupedData[key].AREA_OUT = row.LOCT_AREA;
                    groupedData[key].IMG_OUT = row.IMGE_URLX;
                }
            });

            // --- TAMPILKAN KE TABEL ---
            tbody.innerHTML = '';
            const finalRows = Object.values(groupedData);

            if (finalRows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">Data tidak ditemukan.</td></tr>';
            } else {
                finalRows.forEach(item => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${item.EMPL_NMBR}</td>
                            <td>${item.KORX_NAME}</td>
                            <td>${item.TRAN_DATE}</td>
                            <td class="status-in">${item.IN_TIME}</td>
                            <td class="status-out">${item.OUT_TIME}</td>
                            <td>${item.AREA_IN}</td>
                            <td>${item.AREA_OUT}</td>
                            <td>${renderImage(item.IMG_IN)}</td>
                            <td>${renderImage(item.IMG_OUT)}</td>
                        </tr>
                    `;
                });
            }

        } catch (err) {
            console.error(err);
            alert("Gagal mengambil data: " + err.message);
        } finally {
            btn.innerText = "Search Data";
            btn.classList.remove('btn-loading');
        }
    }

    function renderImage(url) {
        if (!url || url === '') return '-';
        return `
            <div class="img-wrapper">
                <img src="${url}" class="thumb">
                <div class="preview-box">
                    <img src="${url}" alt="Preview">
                </div>
            </div>
        `;
    }
</script>

</body>
</html>
