<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìùReport Attendance</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
            --white: #ffffff;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #edf2f7;
            padding: 20px;
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            background: var(--white);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        /* Update Filter Area untuk alignment */
        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            background: var(--light-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            align-items: flex-end; /* Memastikan semua elemen sejajar di bawah */
        }

        .form-group { display: flex; flex-direction: column; flex: 1; min-width: 180px;}
        .form-group label { font-size: 0.75rem; font-weight: bold; margin-bottom: 5px; color: var(--primary-color); }
        .form-group input { padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; outline: none; }
        .form-group input:focus { border-color: var(--accent-color); }

        /* Penyeragaman Button */
        .btn { 
            height: 38px; /* Mengunci tinggi yang sama */
            padding: 0 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: 600; 
            color: white; 
            text-decoration: none;
            display: inline-flex; /* Menggunakan flex untuk centering teks */
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-sizing: border-box; /* Sangat penting agar padding tidak menambah tinggi */
            font-size: 0.85rem;
        }
        
        /* Efek membal saat diklik */
        .btn:active {transform: scale(0.95);}
        .btn-search { background: var(--accent-color); }
        .btn-search:hover { background: #2980b9; transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        /*.btn-search:active { transform: translateY(0); }    */
        .btn-search:active {transform: scale(0.95);}

        .btn-back { background: var(--primary-color); }
        .btn-back:hover { background: #1a252f; transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

        .btn-loading { background: #95a5a6; cursor: not-allowed; }

        /* Table */
        .table-container { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        thead { background: var(--primary-color); color: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        /* EFEK HOVER PADA BARIS TABEL */
        tr:hover {
            background-color: #f1f7ff; /* Warna biru muda pilihanmu */
            color: #000000;            /* Teks otomatis jadi hitam pekat */
            cursor: pointer;           /* Opsional: kursor berubah jadi jari */
            transition: all 0.2s ease; /* Biar perpindahan warnanya halus */
        }
        
        /* Pastikan kalau ada link di dalam tabel, warnanya juga ikut berubah */
        tr:hover td a {
            background-color: #f1f7ff;
            color: #000000;
            font-weight: 600;
        }

        /* Image Hover Preview */
        .img-wrapper { position: relative; display: inline-block; }
        .thumb { width: 45px; height: 45px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; transition: 0.3s; }
        .thumb:hover { border-color: var(--accent-color); }
        
        .preview-box {
            display: none; position: absolute; bottom: 55px; left: 50%;
            transform: translateX(-50%); z-index: 99; background: white;
            padding: 5px; border-radius: 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            border: 1px solid #ddd;
        }
        .preview-box img { width: 200px; border-radius: 5px; display: block; }
        .img-wrapper:hover .preview-box { display: block; }

        .status-in { color: var(--success-color); font-weight: bold; }
        .status-out { color: var(--warning-color); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <header><h2>üóìÔ∏èAttendance Report</h2></header>

    <div class="filter-section">
            <div class="form-group">
                <label>üóìÔ∏è Start Date</label>
                <input type="date" id="startDate">
            </div>
            <div class="form-group">
                <label>üóìÔ∏è End Date</label>
                <input type="date" id="endDate">
            </div>
            <div class="form-group">
                <label>üÜî Employee ID</label>
                <input type="text" id="emplId" placeholder="Employee Number">
            </div>
            <div class="form-group">
                <label>üßî Employee Name</label>
                <input type="text" id="emplNm" placeholder="Employee Name">
            </div>   
        
            <button class="btn btn-search" id="btnSearch" onclick="fetchAttendanceData()">üîé Search</button>
            <a href="dashboard.html" class="btn btn-back">üè† Dashboard</a>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>CODE</th>
                    <th>NAME</th>
                    <th>DATE</th>
                    <th>IN</th>
                    <th>OUT</th>
                    <th>AREA IN</th>
                    <th>AREA OUT</th>
                    <th>IMG IN</th>
                    <th>IMG OUT</th>
                </tr>
            </thead>
            <tbody id="attendanceBody">
                <tr><td colspan="9" style="text-align:center;">‚è≥ Klik Search untuk memuat data...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // Konfigurasi Supabase
    const SUPABASE_URL = 'https://bzrycuvpbsxvutqhxowp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6cnljdXZwYnN4dnV0cWh4b3dwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNTk5OTEsImV4cCI6MjA4NjkzNTk5MX0.MI2suZLflcMbc5AbPCRaT7_pT9qQISrsV5dKA63Si8s';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Set Default Dates on Load
    window.onload = function() {
        const now = new Date();
        //const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        // Set ke tanggal 1, jam 00:00:00 (Waktu Lokal)
        const firstDayObj = new Date(now.getFullYear(), now.getMonth(), 1);        
        // Format ke YYYY-MM-DD secara manual agar tetap di zona waktu lokal
        const year = firstDayObj.getFullYear();
        const month = String(firstDayObj.getMonth() + 1).padStart(2, '0');
        const day = String(firstDayObj.getDate()).padStart(2, '0');
        const firstDay = `${year}-${month}-${day}`;
        const today = now.toISOString().split('T')[0];
        
        document.getElementById('startDate').value = firstDay;
        document.getElementById('endDate').value = today;
    };

    async function fetchAttendanceData() {
        const btn = document.getElementById('btnSearch');
        const tbody = document.getElementById('attendanceBody');
        
        btn.innerText = "‚è≥ Loading...";
        btn.classList.add('btn-loading');
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">‚åõ Mengambil data dari Supabase...</td></tr>';

        try {
            let query = _supabase.from('TH_ATTN01').select('*');

            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const id = document.getElementById('emplId').value;
            const eNm = document.getElementById('emplNm').value;

            if (start) query = query.gte('TRAN_DATE', start);
            if (end) query = query.lte('TRAN_DATE', end);
            //if (id) query = query.eq('EMPL_NMBR', id);
            //if (eNm) query = query.eq('KORX_NAME', eNm);
            if (id) query = query.ilike('EMPL_NMBR', `%${id}%`);
            if (eNm) query = query.ilike('KORX_NAME', `%${eNm}%`);

            // Tambahkan ini sebelum 'const { data, error } = await query;'
            query = query.order('TRAN_DATE', { ascending: false }).order('TRAN_TIME', { ascending: false });            
            const { data, error } = await query;
            if (error) throw error;

            const groupedData = {};
            
            data.forEach(row => {
                const key = `${row.EMPL_NMBR}_${row.TRAN_DATE}`;
                if (!groupedData[key]) {
                    groupedData[key] = {
                        EMPL_NMBR: row.EMPL_NMBR,
                        KORX_NAME: row.KORX_NAME,
                        TRAN_DATE: row.TRAN_DATE,
                        IN_TIME: '-', OUT_TIME: '-',
                        AREA_IN: '-', AREA_OUT: '-',
                        IMG_IN: '', IMG_OUT: ''
                    };
                }

                const status = row.TRAN_STAT ? row.TRAN_STAT.toLowerCase() : "";
                if (status === 'check in') {
                    groupedData[key].IN_TIME = row.TRAN_TIME;
                    groupedData[key].AREA_IN = row.LOCT_AREA;
                    groupedData[key].IMG_IN = row.IMGE_URLX;
                } else if (status === 'check out') {
                    groupedData[key].OUT_TIME = row.TRAN_TIME;
                    groupedData[key].AREA_OUT = row.LOCT_AREA;
                    groupedData[key].IMG_OUT = row.IMGE_URLX;
                }
            });

            tbody.innerHTML = '';
            const finalRows = Object.values(groupedData);

            if (finalRows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">Data tidak ditemukan.</td></tr>';
            } else {
                finalRows.forEach(item => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${item.EMPL_NMBR}</td>
                            <td>${item.KORX_NAME}</td>
                            <td>${item.TRAN_DATE}</td>
                            <td class="status-in">${item.IN_TIME}</td>
                            <td class="status-out">${item.OUT_TIME}</td>
                            <td>${item.AREA_IN}</td>
                            <td>${item.AREA_OUT}</td>
                            <td>${renderImage(item.IMG_IN)}</td>
                            <td>${renderImage(item.IMG_OUT)}</td>
                        </tr>
                    `;
                });
            }
        } catch (err) {
            console.error(err);
            alert("‚õî Gagal mengambil data: " + err.message);
        } finally {
            btn.innerText = "üîé Search";
            btn.classList.remove('btn-loading');
        }
    }

    function renderImage(url) {
        if (!url || url === '') return '-';
        return `
            <div class="img-wrapper">
                <img src="${url}" class="thumb">
                <div class="preview-box">
                    <img src="${url}" alt="Preview">
                </div>
            </div>
        `;
    }
</script>
</body>
</html>
